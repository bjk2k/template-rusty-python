name: Initialize Template

on:
  create:
  push:
    branches:
      - main

jobs:
  initialize:
    if: github.repository != 'your-username/template-rusty-python'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Check if template has been initialized
        id: check_init
        run: |
          if [ -f ".template-initialized" ]; then
            echo "already_initialized=true" >> $GITHUB_OUTPUT
          else
            echo "already_initialized=false" >> $GITHUB_OUTPUT
          fi

      - name: Get repository info
        if: steps.check_init.outputs.already_initialized == 'false'
        id: repo_info
        run: |
          REPO_NAME="${{ github.event.repository.name }}"
          echo "repo_name=${REPO_NAME}" >> $GITHUB_OUTPUT

          # Convert kebab-case to snake_case for Python package
          PYTHON_PACKAGE=$(echo "${REPO_NAME}" | sed 's/-/_/g')
          echo "python_package=${PYTHON_PACKAGE}" >> $GITHUB_OUTPUT

          # Rust core module name (add _core suffix)
          RUST_MODULE="${PYTHON_PACKAGE}_core"
          echo "rust_module=${RUST_MODULE}" >> $GITHUB_OUTPUT

      - name: Initialize template
        if: steps.check_init.outputs.already_initialized == 'false'
        env:
          PROJECT_NAME: ${{ steps.repo_info.outputs.repo_name }}
          PYTHON_PACKAGE_NAME: ${{ steps.repo_info.outputs.python_package }}
          RUST_CORE_MODULE_NAME: ${{ steps.repo_info.outputs.rust_module }}
          AUTHOR_NAME: ${{ github.event.repository.owner.login }}
          AUTHOR_EMAIL: ${{ github.event.repository.owner.email || format('{0}@users.noreply.github.com', github.event.repository.owner.login) }}
          PROJECT_DESCRIPTION: "Add your description here"
        run: |
          # Replace placeholders in files
          find . -type f \( -name "*.toml" -o -name "*.py" -o -name "*.rs" -o -name "*.sh" -o -name "*.md" -o -name "*.nix" -o -name ".envrc" -o -name "justfile" \) | while read file; do
            if [[ "$file" != *".git"* ]] && [[ "$file" != *"template-init.yml"* ]]; then
              sed -i "s|{{PROJECT_NAME}}|${PROJECT_NAME}|g" "$file"
              sed -i "s|{{PYTHON_PACKAGE_NAME}}|${PYTHON_PACKAGE_NAME}|g" "$file"
              sed -i "s|{{RUST_CORE_MODULE_NAME}}|${RUST_CORE_MODULE_NAME}|g" "$file"
              sed -i "s|{{AUTHOR_NAME}}|${AUTHOR_NAME}|g" "$file"
              sed -i "s|{{AUTHOR_EMAIL}}|${AUTHOR_EMAIL}|g" "$file"
              sed -i "s|{{PROJECT_DESCRIPTION}}|${PROJECT_DESCRIPTION}|g" "$file"
              sed -i "s|PYTHON_PACKAGE_NAME_PLACEHOLDER|${PYTHON_PACKAGE_NAME}|g" "$file"
            fi
          done

          # Rename Python package directory
          if [ -d "python/src/PYTHON_PACKAGE_NAME_PLACEHOLDER" ]; then
            mv "python/src/PYTHON_PACKAGE_NAME_PLACEHOLDER" "python/src/${PYTHON_PACKAGE_NAME}"
          fi

          # Create marker file to prevent re-initialization
          touch .template-initialized

          # Remove template-specific files
          rm -f .github/template.yml

      - name: Commit changes
        if: steps.check_init.outputs.already_initialized == 'false'
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add .
          git commit -m "Initialize project from template" || exit 0
          git push

      - name: Remove initialization workflow
        if: steps.check_init.outputs.already_initialized == 'false'
        run: |
          git rm .github/workflows/template-init.yml
          git commit -m "Remove template initialization workflow"
          git push
