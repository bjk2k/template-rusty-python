name: Initialize Template

# Manual trigger only - prevents accidental initialization during template development
# Users must manually run this after creating a repository from the template
on:
  workflow_dispatch:
    inputs:
      project_name:
        description: "Project name (kebab-case, used in pyproject.toml)"
        required: false
        default: ""
      python_package_name:
        description: "Python package name (snake_case, used for imports)"
        required: false
        default: ""
      rust_core_module_name:
        description: "Rust core module name (snake_case)"
        required: false
        default: ""
      author_name:
        description: "Author name"
        required: false
        default: ""
      author_email:
        description: "Author email"
        required: false
        default: ""
      project_description:
        description: "Project description"
        required: false
        default: "Add your description here"
      force_reinitialize:
        description: "Force re-initialization (overrides safety check)"
        type: boolean
        required: false
        default: false

permissions:
  contents: write
  actions: write

jobs:
  initialize:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Detect if this is a template repository
        id: template_check
        run: |
          # Check if we're running in the original template repository
          CURRENT_REPO="${{ github.repository }}"

          # Simple heuristic: if repo name contains "template" and common template indicators exist
          if [[ "$CURRENT_REPO" == *"template"* ]] && [ -f "TEMPLATE.md" ] && [ -f ".github/template.yml" ]; then
            echo "is_template_repo=true" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è This appears to be the template repository itself"
          else
            echo "is_template_repo=false" >> $GITHUB_OUTPUT
            echo "‚úÖ This appears to be a repository created from the template"
          fi

      - name: Check if already initialized
        id: check_init
        run: |
          if [ -f ".template-initialized" ] && [ "${{ inputs.force_reinitialize }}" != "true" ]; then
            echo "already_initialized=true" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è Template already initialized. Use 'force_reinitialize' input to override."
          else
            echo "already_initialized=false" >> $GITHUB_OUTPUT
            if [ "${{ inputs.force_reinitialize }}" == "true" ]; then
              echo "üîÑ Force re-initialization requested"
            fi
          fi

      - name: Exit if template repository
        if: steps.template_check.outputs.is_template_repo == 'true'
        run: |
          echo "üõë This workflow should not be run on the template repository itself!"
          echo "This workflow is designed to initialize repositories created FROM the template."
          echo "If you need to test the initialization process, create a test repository from this template."
          exit 1

      - name: Exit if already initialized
        if: steps.check_init.outputs.already_initialized == 'true'
        run: |
          echo "‚è≠Ô∏è Template already initialized. Skipping initialization."
          echo "If you need to re-initialize, set 'force_reinitialize' to true."
          exit 0

      - name: Determine project parameters
        id: repo_info
        run: |
          # Use input values if provided, otherwise derive from repository name
          REPO_NAME="${{ github.event.repository.name }}"

          # Project name (kebab-case)
          if [ -n "${{ inputs.project_name }}" ]; then
            PROJECT_NAME="${{ inputs.project_name }}"
          else
            PROJECT_NAME="$REPO_NAME"
          fi
          echo "project_name=${PROJECT_NAME}" >> $GITHUB_OUTPUT

          # Python package name (snake_case)
          if [ -n "${{ inputs.python_package_name }}" ]; then
            PYTHON_PACKAGE="${{ inputs.python_package_name }}"
          else
            # Convert kebab-case to snake_case
            PYTHON_PACKAGE=$(echo "${PROJECT_NAME}" | sed 's/-/_/g' | sed 's/[^a-zA-Z0-9_]/_/g' | tr '[:upper:]' '[:lower:]')
          fi
          echo "python_package=${PYTHON_PACKAGE}" >> $GITHUB_OUTPUT

          # Rust core module name
          if [ -n "${{ inputs.rust_core_module_name }}" ]; then
            RUST_MODULE="${{ inputs.rust_core_module_name }}"
          else
            # Add _core suffix to python package name
            RUST_MODULE="${PYTHON_PACKAGE}_core"
          fi
          echo "rust_module=${RUST_MODULE}" >> $GITHUB_OUTPUT

          # Author information
          if [ -n "${{ inputs.author_name }}" ]; then
            AUTHOR_NAME="${{ inputs.author_name }}"
          else
            # Try to get from repository owner, fallback to actor
            AUTHOR_NAME="${{ github.repository_owner }}"
            if [ "$AUTHOR_NAME" == "" ]; then
              AUTHOR_NAME="${{ github.actor }}"
            fi
          fi
          echo "author_name=${AUTHOR_NAME}" >> $GITHUB_OUTPUT

          if [ -n "${{ inputs.author_email }}" ]; then
            AUTHOR_EMAIL="${{ inputs.author_email }}"
          else
            # Use noreply email as fallback
            AUTHOR_EMAIL="${{ github.actor }}@users.noreply.github.com"
          fi
          echo "author_email=${AUTHOR_EMAIL}" >> $GITHUB_OUTPUT

          # Project description
          PROJECT_DESC="${{ inputs.project_description }}"
          if [ "$PROJECT_DESC" == "" ]; then
            PROJECT_DESC="Add your description here"
          fi
          echo "project_description=${PROJECT_DESC}" >> $GITHUB_OUTPUT

          # Log the determined values
          echo "üìã Project Parameters:"
          echo "  Project Name: ${PROJECT_NAME}"
          echo "  Python Package: ${PYTHON_PACKAGE}"
          echo "  Rust Module: ${RUST_MODULE}"
          echo "  Author: ${AUTHOR_NAME} <${AUTHOR_EMAIL}>"
          echo "  Description: ${PROJECT_DESC}"

      - name: Validate parameters
        env:
          PROJECT_NAME: ${{ steps.repo_info.outputs.project_name }}
          PYTHON_PACKAGE_NAME: ${{ steps.repo_info.outputs.python_package }}
          RUST_CORE_MODULE_NAME: ${{ steps.repo_info.outputs.rust_module }}
        run: |
          # Validate project name (kebab-case)
          if ! echo "$PROJECT_NAME" | grep -qE '^[a-z][a-z0-9-]*[a-z0-9]$|^[a-z][a-z0-9]*$'; then
            echo "‚ùå Invalid project name: $PROJECT_NAME"
            echo "Project name should be kebab-case (lowercase, hyphens allowed)"
            exit 1
          fi

          # Validate Python package name (snake_case)
          if ! echo "$PYTHON_PACKAGE_NAME" | grep -qE '^[a-z][a-z0-9_]*$'; then
            echo "‚ùå Invalid Python package name: $PYTHON_PACKAGE_NAME"
            echo "Python package name should be snake_case (lowercase, underscores allowed)"
            exit 1
          fi

          # Validate Rust module name (snake_case)
          if ! echo "$RUST_CORE_MODULE_NAME" | grep -qE '^[a-z][a-z0-9_]*$'; then
            echo "‚ùå Invalid Rust module name: $RUST_CORE_MODULE_NAME"
            echo "Rust module name should be snake_case (lowercase, underscores allowed)"
            exit 1
          fi

          echo "‚úÖ All parameters are valid"

      - name: Replace template placeholders
        env:
          PROJECT_NAME: ${{ steps.repo_info.outputs.project_name }}
          PYTHON_PACKAGE_NAME: ${{ steps.repo_info.outputs.python_package }}
          RUST_CORE_MODULE_NAME: ${{ steps.repo_info.outputs.rust_module }}
          AUTHOR_NAME: ${{ steps.repo_info.outputs.author_name }}
          AUTHOR_EMAIL: ${{ steps.repo_info.outputs.author_email }}
          PROJECT_DESCRIPTION: ${{ steps.repo_info.outputs.project_description }}
        run: |
          echo "üîÑ Replacing template placeholders..."

          # Find and replace placeholders in non-workflow files
          find . -type f \( \
            -name "*.toml" -o \
            -name "*.py" -o \
            -name "*.rs" -o \
            -name "*.sh" -o \
            -name "*.md" -o \
            -name "*.nix" -o \
            -name ".envrc" -o \
            -name "justfile" \
          \) -not -path "./.git/*" -not -path "./.github/workflows/*" | while read -r file; do
            if [ -f "$file" ]; then
              # Use temporary file to avoid issues with in-place editing
              temp_file=$(mktemp)
              sed "s|{{PROJECT_NAME}}|${PROJECT_NAME}|g; \
                   s|{{PYTHON_PACKAGE_NAME}}|${PYTHON_PACKAGE_NAME}|g; \
                   s|{{RUST_CORE_MODULE_NAME}}|${RUST_CORE_MODULE_NAME}|g; \
                   s|{{AUTHOR_NAME}}|${AUTHOR_NAME}|g; \
                   s|{{AUTHOR_EMAIL}}|${AUTHOR_EMAIL}|g; \
                   s|{{PROJECT_DESCRIPTION}}|${PROJECT_DESCRIPTION}|g; \
                   s|PYTHON_PACKAGE_NAME_PLACEHOLDER|${PYTHON_PACKAGE_NAME}|g" \
                   "$file" > "$temp_file" && mv "$temp_file" "$file"
            fi
          done

          echo "‚úÖ Template placeholders replaced"

      - name: Create workflow update instructions
        env:
          PROJECT_NAME: ${{ steps.repo_info.outputs.project_name }}
          PYTHON_PACKAGE_NAME: ${{ steps.repo_info.outputs.python_package }}
          RUST_CORE_MODULE_NAME: ${{ steps.repo_info.outputs.rust_module }}
        run: |
          echo "üìù Creating workflow update instructions..."

          # Create a script to update workflow files manually
          cat > update-workflows.sh << 'EOF'
          #!/bin/bash
          # Post-initialization workflow update script
          # Run this manually after template initialization

          echo "üîß Updating workflow files with project-specific values..."

          if [ -f ".github/workflows/ci.yml" ]; then
            sed -i "s|{{PROJECT_NAME}}|PROJECT_NAME_VALUE|g; \
                    s|{{PYTHON_PACKAGE_NAME}}|PYTHON_PACKAGE_VALUE|g; \
                    s|{{RUST_CORE_MODULE_NAME}}|RUST_CORE_MODULE_VALUE|g" \
                    ".github/workflows/ci.yml"
            echo "‚úÖ CI workflow updated"
          fi

          echo "üßπ Cleaning up..."
          rm -f update-workflows.sh

          echo "‚úÖ Workflow files updated successfully!"
          EOF

          # Replace placeholders in the script
          sed -i "s|PROJECT_NAME_VALUE|${PROJECT_NAME}|g; \
                  s|PYTHON_PACKAGE_VALUE|${PYTHON_PACKAGE_NAME}|g; \
                  s|RUST_CORE_MODULE_VALUE|${RUST_CORE_MODULE_NAME}|g" \
                  update-workflows.sh

          chmod +x update-workflows.sh

          echo "‚úÖ Workflow update script created"

      - name: Rename Python package directory
        env:
          PYTHON_PACKAGE_NAME: ${{ steps.repo_info.outputs.python_package }}
        run: |
          if [ -d "python/src/PYTHON_PACKAGE_NAME_PLACEHOLDER" ]; then
            echo "üìÅ Renaming Python package directory to: ${PYTHON_PACKAGE_NAME}"
            mv "python/src/PYTHON_PACKAGE_NAME_PLACEHOLDER" "python/src/${PYTHON_PACKAGE_NAME}"
            echo "‚úÖ Python package directory renamed"
          else
            echo "‚ö†Ô∏è Python package placeholder directory not found, skipping rename"
          fi

      - name: Update Cargo.lock hash placeholder
        run: |
          # The Cargo.lock hash will be invalid after template initialization
          # We'll remove it so it gets generated on first build
          if [ -f "flake.nix" ]; then
            sed -i 's/cargoHash = "sha256-AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA=";/cargoHash = ""; # Will be updated on first build/' flake.nix
          fi

      - name: Clean up template-specific files
        run: |
          echo "üßπ Cleaning up template-specific files..."

          # Remove template configuration and documentation
          rm -f .github/template.yml
          rm -f TEMPLATE.md

          echo "‚úÖ Template cleanup complete"

      - name: Create initialization marker
        env:
          PROJECT_NAME: ${{ steps.repo_info.outputs.project_name }}
          PYTHON_PACKAGE_NAME: ${{ steps.repo_info.outputs.python_package }}
          RUST_CORE_MODULE_NAME: ${{ steps.repo_info.outputs.rust_module }}
          AUTHOR_NAME: ${{ steps.repo_info.outputs.author_name }}
          AUTHOR_EMAIL: ${{ steps.repo_info.outputs.author_email }}
          PROJECT_DESCRIPTION: ${{ steps.repo_info.outputs.project_description }}
        run: |
          cat > .template-initialized << EOF
          # Template Initialization Record
          # This file indicates that the template has been initialized
          # Generated on: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          # Initialized by: ${{ github.actor }}

          PROJECT_NAME="${PROJECT_NAME}"
          PYTHON_PACKAGE_NAME="${PYTHON_PACKAGE_NAME}"
          RUST_CORE_MODULE_NAME="${RUST_CORE_MODULE_NAME}"
          AUTHOR_NAME="${AUTHOR_NAME}"
          AUTHOR_EMAIL="${AUTHOR_EMAIL}"
          PROJECT_DESCRIPTION="${PROJECT_DESCRIPTION}"
          TEMPLATE_VERSION="$(date -u +"%Y-%m-%d")"
          INITIALIZED_FROM="${{ github.repository }}"
          EOF

          echo "‚úÖ Initialization marker created"

      - name: Commit changes
        env:
          PROJECT_NAME: ${{ steps.repo_info.outputs.project_name }}
        run: |
          # Configure git
          git config --local user.email "action@github.com"
          git config --local user.name "Template Initialization Bot"

          # Add all changes EXCEPT workflow files
          git add .
          git reset HEAD .github/workflows/ 2>/dev/null || true

          # Check if there are changes to commit
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            echo "üìù Committing template initialization changes..."
            git commit -m "üéâ Initialize ${PROJECT_NAME} from template

            - Replace template placeholders with project-specific values
            - Rename Python package directory
            - Clean up template-specific files
            - Set up project structure

            Generated by template-init workflow"

            # Push changes
            git push origin ${{ github.ref_name }}
            echo "‚úÖ Changes committed and pushed"
          fi

      - name: Remove initialization workflow
        run: |
          echo "üóëÔ∏è Removing template initialization workflow..."

          # Remove this workflow file
          git rm .github/workflows/template-init.yml

          git commit -m "üßπ Remove template initialization workflow

          Template initialization complete. Workflow files need manual update.
          Run './update-workflows.sh' to complete the setup." || {
            echo "‚ö†Ô∏è Failed to commit workflow removal, but initialization completed"
          }

          git push origin ${{ github.ref_name }} || {
            echo "‚ö†Ô∏è Failed to push workflow removal, but initialization completed"
          }

          echo "‚úÖ Initialization workflow removed"

      - name: Summary
        env:
          PROJECT_NAME: ${{ steps.repo_info.outputs.project_name }}
          PYTHON_PACKAGE_NAME: ${{ steps.repo_info.outputs.python_package }}
        run: |
          echo "üéâ Template initialization complete!"
          echo ""
          echo "üìã Your project '${PROJECT_NAME}' is now ready for development."
          echo ""
          echo "üöÄ Next steps:"
          echo "1. Clone your repository locally"
          echo "2. Install Nix (recommended) or set up manually"
          echo "3. Run 'just setup' to initialize the development environment"
          echo "4. Run 'just check' to verify everything works"
          echo ""
          echo "üìö Documentation:"
          echo "- README.md - Main project documentation"
          echo "- NIX.md - Nix development environment guide"
          echo "- DEVELOPMENT.md - Detailed development guide"
          echo ""
          echo "‚ö†Ô∏è  IMPORTANT: Complete the setup by running:"
          echo "  ./update-workflows.sh"
          echo ""
          echo "This will update the CI workflow files with your project details."
          echo "The script will delete itself after running."
          echo ""
          echo "üîß Available commands (with Just):"
          echo "- just setup   # Initial setup"
          echo "- just dev     # Development build"
          echo "- just test    # Run tests"
          echo "- just --list  # Show all commands"
