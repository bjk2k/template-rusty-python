#!/usr/bin/env bash

# {{PROJECT_NAME}} direnv configuration
# This file enables automatic environment setup when entering the project directory

# Use Nix flake for development environment
if command -v nix &> /dev/null && [ -f flake.nix ]; then
    echo "ðŸ¦€ðŸ Loading {{PROJECT_NAME}} development environment via Nix flake..."
    use flake

    # Verify that critical tools are available after loading
    if ! command -v just &> /dev/null; then
        echo "âŒ Just not found in Nix environment. There may be an issue with the flake."
        echo "   Try: nix develop --reload"
    fi

    if ! command -v maturin &> /dev/null; then
        echo "âŒ Maturin not found in Nix environment. There may be an issue with the flake."
    fi

    if ! command -v uv &> /dev/null; then
        echo "âŒ UV not found in Nix environment. There may be an issue with the flake."
    fi
else
    echo "âš ï¸  Nix not found or flake.nix missing."
    echo "   Please install Nix with flakes enabled for the best development experience."
    echo "   Fallback: Use the manual setup instructions in README.md"
fi

# Set up Python environment if it exists
if [ -d "python/.venv" ]; then
    echo "ðŸ Activating Python virtual environment..."
    source python/.venv/bin/activate
elif [ -d "python" ]; then
    echo "ðŸ’¡ Python virtual environment not found."
    if command -v just &> /dev/null; then
        echo "   Run 'just setup' to create it."
    else
        echo "   See README.md for manual setup instructions."
    fi
fi

# Set environment variables for development
export RUST_BACKTRACE=1
export PYTHONDONTWRITEBYTECODE=1
export PYTHONUNBUFFERED=1

# Set UV to prefer system Python (from Nix)
export UV_PYTHON_PREFERENCE=system

# Rust development settings
export CARGO_BUILD_RUSTFLAGS="-C target-cpu=native"
export RUST_SRC_PATH="${RUST_SRC_PATH:-$(rustc --print sysroot 2>/dev/null)/lib/rustlib/src/rust/library}"

# Development conveniences (only if tools are available)
if command -v just &> /dev/null; then
    alias build="just dev"
    alias test="just test"
    alias fmt="just fmt"
    alias lint="just lint"
    alias setup="just setup"
    alias clean="just clean"
    alias check="just check"
fi

# Show helpful information when environment loads
echo ""
echo "ðŸ“ Project: {{PROJECT_NAME}}"

if command -v just &> /dev/null; then
    echo "ðŸŽ¯ Environment loaded successfully!"
    echo ""
    echo "Available commands (via Just):"
    echo "  setup  - Set up development environment"
    echo "  dev    - Build Rust extension in development mode"
    echo "  test   - Run all tests"
    echo "  fmt    - Format all code"
    echo "  lint   - Lint all code"
    echo "  check  - Quick sanity check"
    echo "  clean  - Clean build artifacts"
    echo ""
    echo "Quick start:"
    if [ ! -d "python/.venv" ]; then
        echo "  1. setup    # Set up environment"
        echo "  2. check    # Verify everything works"
    else
        echo "  1. dev      # Build the Rust extension"
        echo "  2. test     # Run tests to verify everything works"
    fi
    echo ""
    echo "ðŸ’¡ Run 'just --list' to see all available commands"
else
    echo "âš ï¸  Just command runner not available"
    echo "   Using Nix? Try: nix develop --reload"
fi

echo ""

# Check if development environment is properly set up
if [ ! -d "python/.venv" ]; then
    if command -v just &> /dev/null; then
        echo "âš¡ Run 'setup' to initialize the development environment"
    else
        echo "âš¡ See README.md for setup instructions"
    fi
    echo ""
fi
